# Версия формата docker-compose
version: "3.9"

# Описываем список сервисов (контейнеров)
services:
  # Первый сервис — Redis
  # Это отдельное in-memory хранилище ключ-значение,
  # которое мы будем использовать позже для хранения состояний бота (FSM) и кэшей
  redis:
    # Используем официальный образ Redis на базе лёгкого Alpine Linux
    image: redis:7-alpine
    # Имя контейнера Redis, чтобы его было легко найти в списке контейнеров
    container_name: payflow-redis
    # Политика перезапуска: перезапускать автоматически, если контейнер упал,
    # и не трогать, если ты его остановил вручную
    restart: unless-stopped

  # Второй сервис — наш Telegram-бот ПОТОК Lite
  bot:
    # Описываем, как собирать Docker-образ для бота
    build:
      # context — корневая папка проекта на хосте.
      # ".." означает "один уровень вверх от папки infra",
      # то есть корень payflow-lite
      context: ..
      # dockerfile — путь к Dockerfile относительно context
      # Здесь явно указываем, что Dockerfile лежит в services/bot/Dockerfile
      dockerfile: services/bot/Dockerfile
    # Имя контейнера бота
    container_name: payflow-bot
    # Файл с переменными окружения, которые нужно передать внутрь контейнера
    # Тут указан путь ../.env — т.е. файл .env лежит в корне проекта
    env_file:
      - ../.env
    # Зависимости: сначала должен быть запущен Redis, потом бот
    depends_on:
      - redis
    # Политика перезапуска для бота: перезапускать, если он упал,
    # не трогать, если остановлен вручную
    restart: unless-stopped
