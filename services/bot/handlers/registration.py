# services/bot/handlers/registration.py

import asyncio                                   # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º asyncio (–º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á, —Ö–æ—Ç—è –∑–¥–µ—Å—å –Ω–∞–ø—Ä—è–º—É—é –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

from aiogram import Router, F                    # Router ‚Äî –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤, F ‚Äî –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—è–º –∞–ø–¥–µ–π—Ç–∞
from aiogram.types import Message, CallbackQuery, ReplyKeyboardRemove  # –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π, callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ–±—ä–µ–∫—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
from aiogram.filters import CommandStart         # –§–∏–ª—å—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start
from aiogram.fsm.context import FSMContext       # –ö–æ–Ω—Ç–µ–∫—Å—Ç FSM –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º

from ..states.registration import RegistrationStates  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

from ..texts.registration import (               # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    REQUEST_PHONE_TEXT,                          # –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    BANK_CHOICE_TEXT_TEMPLATE,                   # –®–∞–±–ª–æ–Ω —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤"
    NO_BANK_TEXT,                                # –¢–µ–∫—Å—Ç –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
    MAIN_BANK_CHOICE_TEXT_TEMPLATE,              # –®–∞–±–ª–æ–Ω —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
    BANK_CHOICE_DONE_TEXT_TEMPLATE,              # –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
    NO_BANK_THANKS_TEXT,                         # –¢–µ–∫—Å—Ç –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–æ–≥–∞–µ—Ç —Å –Ω–æ–≤—ã–º –±–∞–Ω–∫–æ–º
)

from ..keyboards.registration import (           # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏-—Å—Ç—Ä–æ–∏—Ç–µ–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
    build_request_phone_keyboard,                # Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    build_bank_choice_keyboard,                  # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤"
    build_main_bank_choice_keyboard,             # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
    build_no_bank_keyboard,                      # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
)

from ..tools.banks_wordbook import BANKS         # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –±–∞–Ω–∫–∞–º (code, button_title, message_title, emoji)

from ..tools.safe_edit import (               # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    safe_edit_text,                              # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ message.edit_text(...)
    safe_edit_reply_markup,                      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ message.edit_reply_markup(...)
)

from ..tools.remove_keyboards import remove_previous_bot_keyboard  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É–±–∏—Ä–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞


# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤
registration_router = Router(name="registration")  # –î–∞—ë–º —Ä–æ—É—Ç–µ—Ä—É –∏–º—è "registration" –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã


@registration_router.message(CommandStart())     # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /start
async def cmd_start(message: Message, state: FSMContext) -> None:
    """
    –°—Ç–∞—Ä—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–®–∞–≥ 1 –∏–∑ 3).
    """

    # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–±—É–µ–º —É–±—Ä–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –µ–≥–æ ID –µ—Å—Ç—å –≤ FSM).
    await remove_previous_bot_keyboard(
        state=state,                             # –ü–µ—Ä–µ–¥–∞—ë–º FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –∏–∑ –Ω–µ–≥–æ –¥–æ—Å—Ç–∞—Ç—å last_bot_message_id
        bot=message.bot,                         # –û–±—ä–µ–∫—Ç –±–æ—Ç–∞ –±–µ—Ä—ë–º –∏–∑ message.bot
        chat_id=message.chat.id,                 # ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ (–¥–∏–∞–ª–æ–≥–∞)
    )

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ FSM, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å "—á–∏—Å—Ç—É—é" —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.
    await state.clear()

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: —Ç–µ–ø–µ—Ä—å –∂–¥—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    await state.set_state(RegistrationStates.waiting_for_phone)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π.
    sent_message = await message.answer(
        text=REQUEST_PHONE_TEXT,                 # –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        reply_markup=build_request_phone_keyboard(),  # Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        parse_mode="Markdown",                  # –£–∫–∞–∑—ã–≤–∞–µ–º Markdown, —á—Ç–æ–±—ã *–∂–∏—Ä–Ω—ã–π* –∏ —Ç.–ø. —Ä–∞–±–æ—Ç–∞–ª–∏
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –≤ FSM, —á—Ç–æ–±—ã –ø–æ–∑–∂–µ —É–±—Ä–∞—Ç—å —É –Ω–µ–≥–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
    await state.update_data(last_bot_message_id=sent_message.message_id)


@registration_router.message(RegistrationStates.waiting_for_phone)  # –•—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_phone
async def process_phone(message: Message, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç).
    –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–®–∞–≥ 2 –∏–∑ 3).
    """

    phone: str | None = None                     # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é phone, –≥–¥–µ –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–º–µ—Ä –∏–ª–∏ None

    if message.contact and message.contact.phone_number:  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–Ω—Ç–∞–∫—Ç (—á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É)
        phone = "+" + message.contact.phone_number        # –ë–µ—Ä—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ contact –∏ –¥–æ–±–∞–≤–ª—è–µ–º "+" –≤ –Ω–∞—á–∞–ª–æ
    else:                                                 # –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        phone = message.text.strip() if message.text else None  # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –Ω–æ–º–µ—Ä –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å

    if not phone:                                        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –Ω–æ–º–µ—Ä —Ç–∞–∫ –∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω
        # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
        await remove_previous_bot_keyboard(
            state=state,                                 # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
            bot=message.bot,                             # –û–±—ä–µ–∫—Ç –±–æ—Ç–∞
            chat_id=message.chat.id,                     # ID —á–∞—Ç–∞
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –µ—â—ë —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        sent_message = await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –µ—â—ë —Ä–∞–∑."
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ last_bot_message_id.
        await state.update_data(last_bot_message_id=sent_message.message_id)

        return                                           # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞, –æ—Å—Ç–∞–≤–∞—è—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_phone

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ FSM –ø–æ–¥ –∫–ª—é—á–æ–º "phone".
    await state.update_data(phone=phone)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –≤ FSM –∫–∞–∫ –ø—É—Å—Ç–æ–π (–±—É–¥–µ–º –Ω–∞–ø–æ–ª–Ω—è—Ç—å –µ–≥–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ).
    await state.update_data(selected_banks=[])

    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM: —Ç–µ–ø–µ—Ä—å –∂–¥—ë–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–Ω—ë—Ç –≤—ã–±–∏—Ä–∞—Ç—å –±–∞–Ω–∫–∏.
    await state.set_state(RegistrationStates.waiting_for_banks)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤", –ø–æ–¥—Å—Ç–∞–≤–∏–≤ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω.
    text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

    # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏—è —à–∞–≥–∞ 2 —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å.
    await remove_previous_bot_keyboard(
        state=state,
        bot=message.bot,
        chat_id=message.chat.id,
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤.
    sent_message = await message.answer(
        text=text,
        reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ü–µ—Ä–µ–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
        parse_mode="Markdown",
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ last_bot_message_id.
    await state.update_data(last_bot_message_id=sent_message.message_id)


@registration_router.callback_query(              # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–æ–≤
    RegistrationStates.waiting_for_banks,         # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_banks
    F.data.startswith("bank:"),                   # –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "bank:"
)
async def process_bank_choice(
    callback: CallbackQuery,                      # –û–±—ä–µ–∫—Ç callback-–∑–∞–ø—Ä–æ—Å–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ)
    state: FSMContext,                            # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (—à–∞–≥ 2).

    –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã callback.data:
    - "bank:<code>"   ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –µ–≥–æ –≤ selected_banks);
    - "bank:no_such"  ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª;
    - "bank:next"     ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–î–∞–ª–µ–µ ‚û°¬ª –∏ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤,
                        –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª.
    """

    data = callback.data                          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É callback_data, –ø—Ä–∏—à–µ–¥—à—É—é –æ—Ç –∫–Ω–æ–ø–∫–∏

    _, action = data.split(":", maxsplit=1)       # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ ":", –ø–æ–ª—É—á–∞–µ–º –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å ‚Äî –∫–æ–¥ –±–∞–Ω–∫–∞ –∏–ª–∏ —Å–ø–µ—Ü-–¥–µ–π—Å—Ç–≤–∏–µ

    fsm_data = await state.get_data()             # –ß–∏—Ç–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ FSM –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    phone: str = fsm_data.get("phone", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")  # –î–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

    selected_banks: list[str] = fsm_data.get(     # –î–æ—Å—Ç–∞—ë–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä)
        "selected_banks",
        [],
    )

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 1: –ö–ù–û–ü–ö–ê ¬´–ù–ï–¢ –ù–£–ñ–ù–û–ì–û –ë–ê–ù–ö–ê üòü¬ª ----------

    if action == "no_such":                       # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ "bank:" –ø—Ä–∏—à–ª–æ "no_such"
        no_banks_keyboard = build_no_bank_keyboard()  # –°—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –±–∞–Ω–∫–∞"

        await callback.answer()                   # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback (–∑–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏") –±–µ–∑ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞

        # –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏–π "–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
        await safe_edit_text(
            callback.message,                     # –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
            text=NO_BANK_TEXT,                    # –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            reply_markup=no_banks_keyboard,       # –ù–æ–≤–∞—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        )

        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ no_banks.
        await state.set_state(RegistrationStates.no_banks)

        # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id –∫–∞–∫ ID —ç—Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
        await state.update_data(last_bot_message_id=callback.message.message_id)

        return                                    # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ö—ç–Ω–¥–ª–µ—Ä

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 2: –ö–ù–û–ü–ö–ê ¬´–î–ê–õ–ï–ï ‚û°¬ª (–ó–ê–í–ï–†–®–ï–ù–ò–ï –í–´–ë–û–†–ê –ë–ê–ù–ö–û–í) ----------

    if action == "next":                          # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ ‚û°"
        if not selected_banks:                    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –±–∞–Ω–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω
            await callback.answer(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª.",
                show_alert=True,                  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –∞–ª–µ—Ä—Ç –ø–æ–≤–µ—Ä—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            )
            return                                # –ù–µ –¥–∞—ë–º —É–π—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –±–µ–∑ –≤—ã–±–æ—Ä–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –±–∞–Ω–∫–∞

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —á–∏—Ç–∞–µ–º—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –±–∞–Ω–∫–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º message_title).
        readable_banks = [
            BANKS[code]["message_title"]          # –ë–µ—Ä—ë–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –ø–æ –∫–æ–¥—É
            for code in selected_banks            # –î–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –±–∞–Ω–∫–æ–≤
        ]
        banks_list_str = ", ".join(readable_banks)  # –°–∫–ª–µ–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞", –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤.
        main_bank_text = MAIN_BANK_CHOICE_TEXT_TEMPLATE.format(
            phone=phone,
            banks_list=banks_list_str,
        )

        # –°—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞.
        main_bank_keyboard = build_main_bank_choice_keyboard(
            available_banks=selected_banks,       # –î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∏
            main_bank=None,                       # –ü–æ–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ FSM: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∏ –∏ —è–≤–Ω–æ –æ–±–Ω—É–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π.
        await state.update_data(
            selected_banks=selected_banks,
            main_bank=None,
        )

        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
        await state.set_state(RegistrationStates.waiting_for_main_bank)

        await callback.answer()                  # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
        await safe_edit_text(
            callback.message,
            text=main_bank_text,
            reply_markup=main_bank_keyboard,
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id.
        await state.update_data(last_bot_message_id=callback.message.message_id)

        return                                  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ö—ç–Ω–¥–ª–µ—Ä

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 3: –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ë–ê–ù–ö–ê –í –ú–£–õ–¨–¢–ò–í–´–ë–û–†–ï ----------

    bank_code = action                          # –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ action ‚Äî —ç—Ç–æ –∫–æ–¥ –±–∞–Ω–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sber", "tbank" –∏ —Ç.–¥.)

    if bank_code in selected_banks:             # –ï—Å–ª–∏ —ç—Ç–æ—Ç –±–∞–Ω–∫ —É–∂–µ –≤—ã–±—Ä–∞–Ω
        selected_banks.remove(bank_code)        # –£–±–∏—Ä–∞–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–∏–º–∞–µ—Ç –≥–∞–ª–æ—á–∫—É)
    else:
        selected_banks.append(bank_code)        # –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–≤–∏—Ç –≥–∞–ª–æ—á–∫—É)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –≤ FSM.
    await state.update_data(selected_banks=selected_banks)

    # –°—Ç—Ä–æ–∏–º –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤" —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –≥–∞–ª–æ—á–∫–∞–º–∏.
    new_keyboard = build_bank_choice_keyboard(
        selected_banks=selected_banks,
    )

    await callback.answer()                     # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    await safe_edit_reply_markup(
        callback.message,
        reply_markup=new_keyboard,
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id.
    await state.update_data(last_bot_message_id=callback.message.message_id)


@registration_router.callback_query(             # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–æ–≤
    RegistrationStates.waiting_for_main_bank,    # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–æ–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
    F.data.startswith("main_bank:"),             # –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "main_bank:"
)
async def process_main_bank_choice(callback: CallbackQuery, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª.

    –í–æ–∑–º–æ–∂–Ω—ã–µ callback.data:
    - "main_bank:<code>" ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–∞–Ω–∫ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π;
    - "main_bank:back"   ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä);
    - "main_bank:next"   ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –±–∞–Ω–∫–æ–≤.
    """

    data: str = callback.data                   # –ë–µ—Ä—ë–º —Å—Ç—Ä–æ–∫—É callback_data, –Ω–∞–ø—Ä–∏–º–µ—Ä "main_bank:sber" –∏–ª–∏ "main_bank:next"
    _, action = data.split(":", maxsplit=1)     # –û—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "main_bank" –æ—Ç –ø–æ–ª–µ–∑–Ω–æ–π —á–∞—Å—Ç–∏ (–∫–æ–¥ –±–∞–Ω–∫–∞ –∏–ª–∏ —Å–ø–µ—Ü-–¥–µ–π—Å—Ç–≤–∏–µ)

    fsm_data: dict = await state.get_data()     # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    phone: str = fsm_data.get("phone", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")    # –î–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞

    selected_banks: list[str] = fsm_data.get("selected_banks", [])  # –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤

    main_bank: str | None = fsm_data.get("main_bank")   # –¢–µ–∫—É—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ (–º–æ–∂–µ—Ç –±—ã—Ç—å None)

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 1: –ö–ù–û–ü–ö–ê ¬´–ù–ê–ó–ê–î¬ª ----------

    if action == "back":
        await state.set_state(RegistrationStates.waiting_for_banks)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —à–∞–≥—É "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤"

        text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)         # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ 2 (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤)

        keyboard = build_bank_choice_keyboard(selected_banks=selected_banks)  # –°—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –±–∞–Ω–∫–∞–º–∏

        await callback.answer()                                      # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —à–∞–≥ 2.
        await safe_edit_text(
            callback.message,
            text=text,
            reply_markup=keyboard,
        )

        await state.update_data(last_bot_message_id=callback.message.message_id)  # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id

        return                                                      # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 2: –ö–ù–û–ü–ö–ê ¬´–î–ê–õ–ï–ï¬ª (–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–°–ù–û–í–ù–û–ì–û –ë–ê–ù–ö–ê) ----------

    if action == "next":
        final_text: str = BANK_CHOICE_DONE_TEXT_TEMPLATE            # –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞

        await callback.answer()                                     # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

        await callback.message.delete()                             # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞

        # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ FSM).
        await remove_previous_bot_keyboard(
            state=state,
            bot=callback.message.bot,
            chat_id=callback.message.chat.id,
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ —É–±–∏—Ä–∞–µ–º –ª—é–±–æ—é reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
        sent_message = await callback.message.answer(
            text=final_text,
            reply_markup=ReplyKeyboardRemove(),
        )

        await state.update_data(last_bot_message_id=sent_message.message_id)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

        await state.clear()                                                  # –û—á–∏—â–∞–µ–º FSM ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–∞–Ω–∫–∞–º –∑–∞–≤–µ—Ä—à–µ–Ω–∞

        return                                                               # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 3: –í–´–ë–û–† –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –û–°–ù–û–í–ù–û–ì–û –ë–ê–ù–ö–ê ----------

    bank_code: str = action                                # –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ action ‚Äî –∫–æ–¥ –±–∞–Ω–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–ª–∏ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π

    main_bank = bank_code                                  # –°—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ç–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –±–∞–Ω–∫ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π

    await state.update_data(main_bank=main_bank)           # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –≤ FSM

    new_keyboard = build_main_bank_choice_keyboard(        # –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        available_banks=selected_banks,
        main_bank=main_bank,
    )

    await callback.answer()                                # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –±–∞–Ω–∫–µ –ø–æ—è–≤–∏–ª–∞—Å—å –≥–∞–ª–æ—á–∫–∞.
    await safe_edit_reply_markup(
        callback.message,
        reply_markup=new_keyboard,
    )

    await state.update_data(last_bot_message_id=callback.message.message_id)  # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id


@registration_router.callback_query(                       # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–æ–≤
    RegistrationStates.no_banks,                          # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ no_banks
    F.data.startswith("no_bank:"),                        # –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "no_bank:"
)
async def no_bank(
    callback: CallbackQuery,                              # –û–±—ä–µ–∫—Ç callback-–∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state: FSMContext,                                    # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—à—ë–ª –Ω—É–∂–Ω—ã–π –±–∞–Ω–∫.

    –í–æ–∑–º–æ–∂–Ω—ã–µ callback.data:
    - "no_bank:back"  ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤;
    - "no_bank:start" ‚Äî –Ω–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞.
    """

    data = callback.data                                  # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É callback_data
    _, action = data.split(":", maxsplit=1)               # –û—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "no_bank" –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è (back / start)

    if action == "back":                                  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ù–∞–∑–∞–¥"
        await state.set_state(RegistrationStates.waiting_for_banks)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —à–∞–≥ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤

        fsm_data = await state.get_data()                 # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ FSM
        phone: str = fsm_data.get("phone", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")  # –î–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞

        text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)  # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤"

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —à–∞–≥—É 2, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
        await safe_edit_text(
            callback.message,
            text=text,
            reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–ª–∏ selected_banks
            parse_mode="Markdown",
        )

        await state.update_data(last_bot_message_id=callback.message.message_id)  # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id

        return

    if action == "start":                                 # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
        await callback.message.delete()                   # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π "–Ω–µ—Ç –±–∞–Ω–∫–∞"
        await state.clear()                               # –û—á–∏—â–∞–µ–º FSM (–ø–æ–ª–Ω—ã–π —Ä–µ—Å–µ—Ç –≤–µ—Ç–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)

        # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ).
        await remove_previous_bot_keyboard(
            state=state,
            bot=callback.message.bot,
            chat_id=callback.message.chat.id,
        )

        await state.set_state(RegistrationStates.waiting_for_phone)  # –°—Ç–∞–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        sent_message = await callback.message.answer(
            text=REQUEST_PHONE_TEXT,
            reply_markup=build_request_phone_keyboard(),
            parse_mode="Markdown",
        )

        await state.update_data(last_bot_message_id=sent_message.message_id)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

        return


@registration_router.message(                            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    RegistrationStates.no_banks,                         # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ no_banks
)
async def process_name(
    message: Message,                                    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state: FSMContext,                                   # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
) -> None:
    """
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
    –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å/—Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–≤–µ–¥—ë–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """

    # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
    await remove_previous_bot_keyboard(
        state=state,
        bot=message.bot,
        chat_id=message.chat.id,
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π.
    sent_message = await message.answer(
        text=NO_BANK_THANKS_TEXT,
        reply_markup=build_no_bank_keyboard(),
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ last_bot_message_id.
    await state.update_data(last_bot_message_id=sent_message.message_id)
