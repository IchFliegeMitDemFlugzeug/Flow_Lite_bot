# handlers/registration.py

import asyncio
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å Router –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤.
from aiogram import Router, F
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã –∞–ø–¥–µ–π—Ç–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å: Message –∏ CallbackQuery.
from aiogram.types import Message, CallbackQuery, ReplyKeyboardRemove
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–æ–º–∞–Ω–¥—ã /start
from aiogram.filters import CommandStart
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç FSM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π.
from aiogram.fsm.context import FSMContext

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
from ..states.registration import RegistrationStates
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π.
from ..texts.registration import (
    REQUEST_PHONE_TEXT,
    BANK_CHOICE_TEXT_TEMPLATE,
    NO_BANK_TEXT,
    MAIN_BANK_CHOICE_TEXT_TEMPLATE,
    BANK_CHOICE_DONE_TEXT_TEMPLATE,
    NO_BANK_THANKS_TEXT,
)
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
from ..keyboards.registration import (
    build_request_phone_keyboard,
    build_bank_choice_keyboard,
    build_main_bank_choice_keyboard,
    build_no_bank_keyboard,
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –±–∞–Ω–∫–æ–≤ (–≤ —Ç.—á. –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç–∞—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
from ..tools.banks_wordbook import BANKS

# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤.
# Router ‚Äî –æ–±—ä–µ–∫—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –º—ã "–ø—Ä–∏—à–∏–≤–∞–µ–º" —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π.
registration_router = Router(name="registration")  # name ‚Äî –ø—Ä–æ—Å—Ç–æ —É–¥–æ–±–Ω–∞—è –º–µ—Ç–∫–∞


@registration_router.message(CommandStart())  # –≠—Ç–æ—Ç —Ö—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /start
async def cmd_start(message: Message, state: FSMContext) -> None:
    """
    –°—Ç–∞—Ä—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–®–∞–≥ 1 –∏–∑ 3).
    """

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ FSM.
    await state.clear()

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∂–¥—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    await state.set_state(RegistrationStates.waiting_for_phone)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –æ–±—ã—á–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞.
    await message.answer(
        text=REQUEST_PHONE_TEXT,                       # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ—Ä—ë–º –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        reply_markup=build_request_phone_keyboard(),  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        parse_mode="Markdown"                         # –£–∫–∞–∑—ã–≤–∞–µ–º Markdown, —á—Ç–æ–±—ã *–∂–∏—Ä–Ω—ã–π* –∏ —Ç.–ø. —Ä–∞–±–æ—Ç–∞–ª–∏
    )


@registration_router.message(RegistrationStates.waiting_for_phone)
async def process_phone(message: Message, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç).
    –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–®–∞–≥ 2 –∏–∑ 3).
    """

    # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    # 1) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" ‚Äî –ø—Ä–∏–¥—ë—Ç –æ–±—ä–µ–∫—Ç contact.
    phone: str | None = None  # –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é phone, —Ç–∏–ø ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ None

    if message.contact and message.contact.phone_number:
        # –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å contact –∏ –≤ –Ω—ë–º –µ—Å—Ç—å phone_number, –±–µ—Ä—ë–º –µ–≥–æ.
        phone = "+" + message.contact.phone_number
    else:
        # –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –Ω–æ–º–µ—Ä –∫–∞–∫ —Ç–µ–∫—Å—Ç.
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —Ç—É—Ç –Ω–∞–¥–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë–º text.
        phone = message.text.strip() if message.text else None

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ‚Äî –ø—Ä–æ—Å–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë —Ä–∞–∑.
    if not phone:
        await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –µ—â—ë —Ä–∞–∑."
        )
        return  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è waiting_for_phone

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –¥–∞–Ω–Ω—ã—Ö FSM (state).
    # FSMContext —Ö—Ä–∞–Ω–∏—Ç —Å–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–∏ —á–∞—Ç—É).
    await state.update_data(phone=phone)

    # –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –∫–∞–∫ –ø—É—Å—Ç–æ–π.
    # –ü–∏—à–µ–º —Å–ø–∏—Å–æ–∫, –∞ –Ω–µ set, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ FSM –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å JSON-—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–º–∏.
    await state.update_data(selected_banks=[])

    # –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∂–¥—ë–º –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤.
    await state.set_state(RegistrationStates.waiting_for_banks)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤": –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω.
    text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤.
    await message.answer(
        text=text,
        reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ø–æ–∫–∞ –Ω–∏ –æ–¥–∏–Ω –±–∞–Ω–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω
        parse_mode="Markdown"
    )


@registration_router.callback_query(             # —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å—ã
    RegistrationStates.waiting_for_banks,        # —Ö—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_banks
    F.data.startswith("bank:")                   # –∏ –∫–æ–≥–¥–∞ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "bank:"
)
async def process_bank_choice(
    callback: CallbackQuery,                     # –æ–±—ä–µ–∫—Ç callback-–∑–∞–ø—Ä–æ—Å–∞ –æ—Ç Telegram
    state: FSMContext                            # –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (—à–∞–≥ 2).

    –¢—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è:
    - bank:<code>   ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–Ω–∫–∞;
    - bank:no_such  ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª;
    - bank:next     ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–î–∞–ª–µ–µ ‚û°¬ª –∏ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤,
                      –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª.
    """

    data = callback.data                         # –ø–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É callback_data, –Ω–∞–ø—Ä–∏–º–µ—Ä: "bank:sber" –∏–ª–∏ "bank:next"

    _, action = data.split(":", maxsplit=1)      # –æ—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "bank:" –∏ –ø–æ–ª—É—á–∞–µ–º –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å: "sber", "no_such" –∏–ª–∏ "next"

    fsm_data = await state.get_data()            # –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    phone: str = fsm_data.get(                   # –¥–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ FSM
        "phone",                                 # –∫–ª—é—á, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"                             # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ—á–µ–º—É-—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    )
    selected_banks: list[str] = fsm_data.get(    # –¥–æ—Å—Ç–∞—ë–º —Å–ø–∏—Å–æ–∫ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
        "selected_banks",                        # –∫–ª—é—á –≤ FSM, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
        []                                       # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
    )

    # 1) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª
    if action == "no_such":                      # –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ "bank:" –∏–¥—ë—Ç "no_such"
        no_banks_keyboard = build_no_bank_keyboard()  # —Å—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –±–∞–Ω–∫–∞"

        await callback.answer()                  # –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        await callback.message.edit_text(        # —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¢–ï–ö–£–©–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ (–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ)
            text=NO_BANK_TEXT,                   # —Ç–µ–∫—Å—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–±—ä—è—Å–Ω—è–µ–º, —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞
            reply_markup=no_banks_keyboard       # –Ω–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        )
        await state.set_state(
            RegistrationStates.no_banks
        )
        return                                   # –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ "no_such" –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞

    # 2) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–î–∞–ª–µ–µ ‚û°¬ª ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤
    if action == "next":                         # –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ "bank:" –ø—Ä–∏—à–ª–æ "next"
        if not selected_banks:                   # –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç–æ–π
            await callback.answer(               # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –º–æ–¥–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª.",
                show_alert=True                  # show_alert=True ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –∞–ª–µ—Ä—Ç –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–º –æ–∫–Ω–µ
            )
            return                               # –Ω–µ –¥–∞—ë–º –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ –±–µ–∑ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –±–∞–Ω–∫–∞

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —á–∏—Ç–∞–µ–º—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –±–∞–Ω–∫–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–∞:
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ "message_title" –∏–∑ —Å–ª–æ–≤–∞—Ä—è BANKS
        readable_banks = [
            BANKS[code]["message_title"]         # —á–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∏–º—è –±–∞–Ω–∫–∞ –ø–æ –µ–≥–æ –∫–æ–¥—É
            for code in selected_banks           # –¥–ª—è –≤—Å–µ—Ö –∫–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª
        ]
        banks_list_str = ", ".join(              # —Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
            readable_banks
        )

        main_bank_text = MAIN_BANK_CHOICE_TEXT_TEMPLATE.format(  # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
            phone=phone,                         # –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —à–∞–±–ª–æ–Ω
            banks_list=banks_list_str            # –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –≤ —à–∞–±–ª–æ–Ω
        )

        main_bank_keyboard = build_main_bank_choice_keyboard(    # —Å—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
            available_banks=selected_banks,      # –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–µ –±–∞–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –Ω–∞ —à–∞–≥–µ 2
            main_bank=None                       # –ø—Ä–∏ –ü–ï–†–ï–•–û–î–ï –Ω–∞ —ç—Ç–æ—Ç —à–∞–≥ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –≤—Å–µ–≥–¥–∞ –ù–ï –≤—ã–±—Ä–∞–Ω
        )

        await state.update_data(                 # –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ FSM
            selected_banks=selected_banks,       # –µ—â—ë —Ä–∞–∑ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            main_bank=None                       # —è–≤–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω
        )
        await state.set_state(                   # –ø–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
            RegistrationStates.waiting_for_main_bank  # —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
        )

        await callback.answer()                  # –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã Telegram —É–±—Ä–∞–ª "—á–∞—Å–∏–∫–∏"

        await callback.message.edit_text(        # –í–ê–ñ–ù–û: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            text=main_bank_text,                 # –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
            reply_markup=main_bank_keyboard      # –Ω–æ–≤–∞—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
        )

        return                                   # –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —à–∞–≥ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞

    # 3) –û—Å—Ç–∞—ë—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π, –∫–æ–≥–¥–∞ action ‚Äî —ç—Ç–æ –∫–æ–¥ –±–∞–Ω–∫–∞ (sber, tbank –∏ —Ç.–ø.)
    bank_code = action                           # –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ–º action –∫–∞–∫ –∫–æ–¥ –±–∞–Ω–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "sber"

    if bank_code in selected_banks:              # –µ—Å–ª–∏ —ç—Ç–æ—Ç –±–∞–Ω–∫ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        selected_banks.remove(bank_code)         # —É–±–∏—Ä–∞–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–æ—Ç–∂–∞–ª" —ç—Ç–æ—Ç –±–∞–Ω–∫
    else:
        selected_banks.append(bank_code)         # –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –µ—â—ë –æ–¥–∏–Ω –±–∞–Ω–∫

    await state.update_data(                     # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –≤ FSM
        selected_banks=selected_banks
    )

    new_keyboard = build_bank_choice_keyboard(   # –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤ (—à–∞–≥ 2)
        selected_banks=selected_banks            # –ø–µ—Ä–µ–¥–∞—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤, —á—Ç–æ–±—ã –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏
    )

    await callback.answer()                      # –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"

    await callback.message.edit_reply_markup(    # —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        reply_markup=new_keyboard                # –ø–µ—Ä–µ–¥–∞—ë–º –Ω–æ–≤—É—é –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —ç–∫—Ä–∞–Ω–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤"
    )


@registration_router.callback_query(
    RegistrationStates.waiting_for_main_bank,   # –•—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
    F.data.startswith("main_bank:")             # –ò —Ç–æ–ª—å–∫–æ –¥–ª—è callback_data, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å "main_bank:"
)
async def process_main_bank_choice(callback: CallbackQuery, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª.

    –í–æ–∑–º–æ–∂–Ω—ã–µ callback.data:
    - "main_bank:<code>" ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–∞–Ω–∫ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π;
    - "main_bank:back"   ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä);
    - "main_bank:next"   ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞.
    """

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É callback_data –∏–∑ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏.
    data: str = callback.data  # –ù–∞–ø—Ä–∏–º–µ—Ä: "main_bank:sber", "main_bank:back", "main_bank:next"

    # –û—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "main_bank" –æ—Ç –ø–æ–ª–µ–∑–Ω–æ–π —á–∞—Å—Ç–∏ (action).
    # split(":", maxsplit=1) –≤–µ—Ä–Ω—ë—Ç —Å–ø–∏—Å–æ–∫ –∏–∑ –¥–≤—É—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ["main_bank", "<action>"]
    _, action = data.split(":", maxsplit=1)

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–ª–æ–≤–∞—Ä—å).
    fsm_data: dict = await state.get_data()

    # –ó–∞–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –Ω–∞ —à–∞–≥–µ 1.
    phone: str = fsm_data.get("phone", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")

    # –ó–∞–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ (—à–∞–≥ 2).
    selected_banks: list[str] = fsm_data.get("selected_banks", [])

    # –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞ (–µ—Å–ª–∏ —É–∂–µ –≤—ã–±–∏—Ä–∞–ª–∏).
    main_bank: str | None = fsm_data.get("main_bank")

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 1: –ö–ù–û–ü–ö–ê ¬´–ù–ê–ó–ê–î¬ª ----------

    if action == "back":
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ —à–∞–≥—É 2 ‚Äî ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä).
        await state.set_state(RegistrationStates.waiting_for_banks)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —à–∞–≥–∞ 2, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

        # –°—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤ —Å —É—á—ë—Ç–æ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö.
        keyboard = build_bank_choice_keyboard(selected_banks=selected_banks)

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ (–±–µ–∑ –≤—Å–ø–ª—ã–≤–∞—à–∫–∏).
        await callback.answer()

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
        #   - –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–µ–∫—Å—Ç —à–∞–≥–∞ 2
        #   - –º–µ–Ω—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
        await callback.message.edit_text(
            text=text,
            reply_markup=keyboard
        )

        # –ë–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏.
        return

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 2: –ö–ù–û–ü–ö–ê ¬´–î–ê–õ–ï–ï¬ª ----------

    if action == "next":
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –≤ –ë–î (–ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è).
        # –ü—Ä–∏–º–µ—Ä: await db.save_main_bank(user_id=callback.from_user.id, bank_code=main_bank)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–æ "–í—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
        final_text: str = BANK_CHOICE_DONE_TEXT_TEMPLATE

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–µ.
        await callback.answer()
        await callback.message.delete()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        await callback.message.answer(
            text=final_text,               # –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            reply_markup=ReplyKeyboardRemove()  # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥—Ä—É–≥—É—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        )

        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM ‚Äî –≤–µ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
        await state.clear()

        # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏.
        return

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 3: –í–´–ë–û–† –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ë–ê–ù–ö–ê –ö–ê–ö –û–°–ù–û–í–ù–û–ì–û ----------

    # –ï—Å–ª–∏ —Å—é–¥–∞ –¥–æ—à–ª–∏ ‚Äî –∑–Ω–∞—á–∏—Ç, action –Ω–µ "back" –∏ –Ω–µ "next".
    # –°—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∫–æ–¥ –±–∞–Ω–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sber", "tbank", "vtb" –∏ —Ç.–ø.).
    bank_code: str = action

    # –ù–∞ —à–∞–≥–µ ¬´–æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫¬ª —É –Ω–∞—Å –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–∞–Ω–∫.
    # –ü—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ main_bank.
    main_bank = bank_code

    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ FSM ‚Äî —Ç–µ–ø–µ—Ä—å —Ç–∞–º –Ω–æ–≤—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫.
    await state.update_data(main_bank=main_bank)

    # –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞:
    #   - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∞–Ω–∫–æ–≤, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ (selected_banks),
    #   - –≤ main_bank –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–¥ –±–∞–Ω–∫–∞, —á—Ç–æ–±—ã –Ω–∞ –Ω—ë–º –ø–æ—è–≤–∏–ª–∞—Å—å "–≥–∞–ª–æ—á–∫–∞".
    new_keyboard = build_main_bank_choice_keyboard(
        available_banks=selected_banks,
        main_bank=main_bank
    )

    # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–µ.
    await callback.answer()

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç —à–∞–≥–∞ 3 –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è).
    await callback.message.edit_reply_markup(reply_markup=new_keyboard)


@registration_router.callback_query(             # —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å—ã
    RegistrationStates.no_banks,                 # —Ö—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ no_banks
    F.data.startswith("no_bank:")                # –∏ –∫–æ–≥–¥–∞ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "no_bank:"
)
async def no_bank(
    callback: CallbackQuery,                     # –æ–±—ä–µ–∫—Ç callback-–∑–∞–ø—Ä–æ—Å–∞ –æ—Ç Telegram
    state: FSMContext                            # –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
) -> None:
    data = callback.data                         # –ø–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É callback_data, –Ω–∞–ø—Ä–∏–º–µ—Ä: "no_bank:back" –∏–ª–∏ "no_bank:start"

    _, action = data.split(":", maxsplit=1)      # –æ—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "no_bank" –∏ –ø–æ–ª—É—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ

    if action == "back":
        await state.set_state(RegistrationStates.waiting_for_banks)

        fsm_data = await state.get_data()        # –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        phone: str = fsm_data.get(               # –¥–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ FSM
            "phone",                             # –∫–ª—é—á, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"                         # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ—á–µ–º—É-—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        )
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤": –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω.
        text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —à–∞–≥ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤.
        await callback.message.edit_text(
            text=text,
            reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ø–æ–∫–∞ –Ω–∏ –æ–¥–∏–Ω –±–∞–Ω–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω
            parse_mode="Markdown"
        )
        return

    if action == "start":
        await callback.message.delete()
        await state.clear()

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∂–¥—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        await state.set_state(RegistrationStates.waiting_for_phone)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –æ–±—ã—á–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞.
        await callback.message.answer(
            text=REQUEST_PHONE_TEXT,                  # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ—Ä—ë–º –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            reply_markup=build_request_phone_keyboard(),  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
            parse_mode="Markdown"                    # –£–∫–∞–∑—ã–≤–∞–µ–º Markdown, —á—Ç–æ–±—ã *–∂–∏—Ä–Ω—ã–π* –∏ —Ç.–ø. —Ä–∞–±–æ—Ç–∞–ª–∏
        )
        return


@registration_router.message(              # –•—ç–Ω–¥–ª–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
    RegistrationStates.no_banks            # –°—Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ FSM
)
async def process_name(                    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
    message: Message,                      # –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state: FSMContext                      # –ö–æ–Ω—Ç–µ–∫—Å—Ç FSM –¥–ª—è —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
) -> None:

    await message.answer(
        text=NO_BANK_THANKS_TEXT,
        reply_markup=build_no_bank_keyboard()
    )
