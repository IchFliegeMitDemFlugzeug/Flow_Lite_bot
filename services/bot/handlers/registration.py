# handlers/registration.py

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å Router –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤.
from aiogram import Router, F
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã –∞–ø–¥–µ–π—Ç–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å: Message –∏ CallbackQuery.
from aiogram.types import Message, CallbackQuery
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–æ–º–∞–Ω–¥—ã /start
from aiogram.filters import CommandStart
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç FSM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π.
from aiogram.fsm.context import FSMContext

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
from ..states.registration import RegistrationStates
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π.
from ..texts.registration import (
    REQUEST_PHONE_TEXT,
    BANK_CHOICE_TEXT_TEMPLATE,
    NO_BANK_TEXT,
    BANK_CHOICE_DONE_TEXT_TEMPLATE,
    NO_BANK_THANKS_TEXT,
)
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
from ..keyboards.registration import (
    build_request_phone_keyboard,
    build_bank_choice_keyboard,
    BANK_LABELS,
)

# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤.
# Router ‚Äî –æ–±—ä–µ–∫—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –º—ã "–ø—Ä–∏—à–∏–≤–∞–µ–º" —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π.
registration_router = Router(name="registration")  # name ‚Äî –ø—Ä–æ—Å—Ç–æ —É–¥–æ–±–Ω–∞—è –º–µ—Ç–∫–∞


@registration_router.message(CommandStart())  # –≠—Ç–æ—Ç —Ö—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /start
async def cmd_start(message: Message, state: FSMContext) -> None:
    """
    –°—Ç–∞—Ä—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–®–∞–≥ 1 –∏–∑ 3).
    """

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ FSM.
    await state.clear()

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∂–¥—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    await state.set_state(RegistrationStates.waiting_for_phone)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –æ–±—ã—á–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞.
    await message.answer(
        text=REQUEST_PHONE_TEXT,                  # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ—Ä—ë–º –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        reply_markup=build_request_phone_keyboard(),  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        parse_mode="Markdown"                    # –£–∫–∞–∑—ã–≤–∞–µ–º Markdown, —á—Ç–æ–±—ã *–∂–∏—Ä–Ω—ã–π* –∏ —Ç.–ø. —Ä–∞–±–æ—Ç–∞–ª–∏
    )


@registration_router.message(RegistrationStates.waiting_for_phone)
async def process_phone(message: Message, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç).
    –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–®–∞–≥ 2 –∏–∑ 3).
    """

    # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    # 1) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" ‚Äî –ø—Ä–∏–¥—ë—Ç –æ–±—ä–µ–∫—Ç contact.
    phone: str | None = None  # –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é phone, —Ç–∏–ø ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ None

    if message.contact and message.contact.phone_number:
        # –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å contact –∏ –≤ –Ω—ë–º –µ—Å—Ç—å phone_number, –±–µ—Ä—ë–º –µ–≥–æ.
        phone = message.contact.phone_number
    else:
        # –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –Ω–æ–º–µ—Ä –∫–∞–∫ —Ç–µ–∫—Å—Ç.
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —Ç—É—Ç –Ω–∞–¥–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë–º text.
        phone = message.text.strip() if message.text else None

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ‚Äî –ø—Ä–æ—Å–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë —Ä–∞–∑.
    if not phone:
        await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –µ—â—ë —Ä–∞–∑."
        )
        return  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è waiting_for_phone

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –¥–∞–Ω–Ω—ã—Ö FSM (state).
    # FSMContext —Ö—Ä–∞–Ω–∏—Ç —Å–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–∏ —á–∞—Ç—É).
    await state.update_data(phone=phone)

    # –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –∫–∞–∫ –ø—É—Å—Ç–æ–π.
    # –ü–∏—à–µ–º —Å–ø–∏—Å–æ–∫, –∞ –Ω–µ set, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ FSM –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å JSON-—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–º–∏.
    await state.update_data(selected_banks=[])

    # –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∂–¥—ë–º –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤.
    await state.set_state(RegistrationStates.waiting_for_banks)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤": –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω.
    text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤.
    await message.answer(
        text=text,
        reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ø–æ–∫–∞ –Ω–∏ –æ–¥–∏–Ω –±–∞–Ω–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω
        parse_mode="Markdown"
    )


@registration_router.callback_query(
    RegistrationStates.waiting_for_banks,
    F.data.startswith("bank:")
)
async def process_bank_choice(callback: CallbackQuery, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª.
    –¢—É—Ç —Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è:
    - bank:<code> ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–Ω–∫–∞;
    - bank:no_such ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª;
    - bank:next ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–î–∞–ª–µ–µ ‚û°¬ª –∏ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–±–æ—Ä.
    """

    # callback.data ‚Äî —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã –∑–∞–¥–∞–ª–∏ –≤ callback_data —É –∫–Ω–æ–ø–∫–∏.
    data = callback.data  # –ù–∞–ø—Ä–∏–º–µ—Ä: "bank:sber" –∏–ª–∏ "bank:next"

    # –û—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "bank:" –æ—Ç –ø–æ–ª–µ–∑–Ω–æ–π —á–∞—Å—Ç–∏.
    _, action = data.split(":", maxsplit=1)  # –ü–æ–ª—É—á–∞–µ–º "sber", "no_such" –∏–ª–∏ "next"

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∏).
    fsm_data = await state.get_data()
    phone: str = fsm_data.get("phone", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")  # –ë–µ—Ä—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    selected_banks: list[str] = fsm_data.get("selected_banks", [])  # –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤

    # 1) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª
    if action == "no_such":
        # –û—Ç–≤–µ—á–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º (alert=True –¥–µ–ª–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–æ—à–∫–æ).
        await callback.answer("–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!", show_alert=True)
        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.
        await callback.message.answer(NO_BANK_TEXT)
        # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–µ –º–µ–Ω—è–µ–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–±–æ—Ä.
        return

    # 2) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–î–∞–ª–µ–µ ‚û°¬ª ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–±–æ—Ä
    if action == "next":
        # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω.
        if not selected_banks:
            await callback.answer(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª.",
                show_alert=True
            )
            return

        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å —Å–ª–µ–¥—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∏ –≤ –ë–î.
        # –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç.
        readable_banks = [BANK_LABELS[code] for code in selected_banks]
        banks_list_str = ", ".join(readable_banks)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω—É.
        done_text = BANK_CHOICE_DONE_TEXT_TEMPLATE.format(
            phone=phone,
            banks_list=banks_list_str
        )

        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏".
        await callback.answer()

        # –ú–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ.
        # –ó–¥–µ—Å—å –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
        await callback.message.answer(done_text)

        # –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∏–Ω–∞–ª).
        # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
        await state.clear()
        return

    # 3) –û—Å—Ç–∞—ë—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π, –∫–æ–≥–¥–∞ action ‚Äî —ç—Ç–æ –∫–æ–¥ –±–∞–Ω–∫–∞ (sber, tbank, ...).
    bank_code = action  # –ù–∞–ø—Ä–∏–º–µ—Ä "sber"

    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–Ω–∫–∞ –≤ —Å–ø–∏—Å–∫–µ selected_banks.
    if bank_code in selected_banks:
        # –ï—Å–ª–∏ –±–∞–Ω–∫ —É–∂–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω ‚Äî —É–±–∏—Ä–∞–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞.
        selected_banks.remove(bank_code)
    else:
        # –ï—Å–ª–∏ –±–∞–Ω–∫–∞ –Ω–µ –±—ã–ª–æ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º.
        selected_banks.append(bank_code)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ –≤ FSM.
    await state.update_data(selected_banks=selected_banks)

    # –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —É—á—ë—Ç–æ–º –Ω–æ–≤—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ (–≥–∞–ª–æ—á–∫–∏ ‚úî).
    new_keyboard = build_bank_choice_keyboard(selected_banks=selected_banks)

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã Telegram —É–±—Ä–∞–ª "—á–∞—Å–∏–∫–∏".
    await callback.answer()

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç –Ω–µ –º–µ–Ω—è–µ–º).
    await callback.message.edit_reply_markup(reply_markup=new_keyboard)
