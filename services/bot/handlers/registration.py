# handlers/registration.py

import asyncio  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å asyncio (–Ω–∞ –±—É–¥—É—â–µ–µ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á, —Ç—É—Ç –Ω–∞–ø—Ä—è–º—É—é –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

from aiogram import Router, F  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Router –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ –∏ F –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—è–º –∞–ø–¥–µ–π—Ç–∞
from aiogram.types import Message, CallbackQuery, ReplyKeyboardRemove  # –¢–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤ Telegram: —Å–æ–æ–±—â–µ–Ω–∏—è, callback-–∑–∞–ø—Ä–æ—Å—ã –∏ —É–¥–∞–ª–µ–Ω–∏–µ reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
from aiogram.filters import CommandStart  # –§–∏–ª—å—Ç—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start
from aiogram.fsm.context import FSMContext  # –ö–æ–Ω—Ç–µ–∫—Å—Ç –º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM), —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –∏ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
from aiogram.exceptions import TelegramBadRequest  # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∫–∏–¥–∞–µ—Ç aiogram, –µ—Å–ª–∏ Telegram –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É Bad Request

from ..states.registration import RegistrationStates  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

from ..texts.registration import (  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç—ã –∏ —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    REQUEST_PHONE_TEXT,               # –¢–µ–∫—Å—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    BANK_CHOICE_TEXT_TEMPLATE,        # –®–∞–±–ª–æ–Ω —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —à–∞–≥–∞ ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª
    NO_BANK_TEXT,                     # –¢–µ–∫—Å—Ç –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ¬´–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª
    MAIN_BANK_CHOICE_TEXT_TEMPLATE,   # –®–∞–±–ª–æ–Ω —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —à–∞–≥–∞ ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª
    BANK_CHOICE_DONE_TEXT_TEMPLATE,   # –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
    NO_BANK_THANKS_TEXT,              # –¢–µ–∫—Å—Ç –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–æ–≥–∞–µ—Ç —Å –Ω–æ–≤—ã–º –±–∞–Ω–∫–æ–º
)

from ..keyboards.registration import (  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—Ä–æ—è—Ç –Ω—É–∂–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    build_request_phone_keyboard,       # Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    build_bank_choice_keyboard,         # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —à–∞–≥–∞ ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª
    build_main_bank_choice_keyboard,    # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —à–∞–≥–∞ ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª
    build_no_bank_keyboard,             # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ¬´–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª
)

from ..tools.banks_wordbook import BANKS  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –±–∞–Ω–∫–æ–≤: –ø–æ –∫–æ–¥—É –±–∞–Ω–∫–∞ –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ


async def safe_edit_text(
    message: Message,  # –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è Telegram, –∫–æ—Ç–æ—Ä–æ–µ –º—ã —Ö–æ—Ç–∏–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    **kwargs,          # –õ—é–±—ã–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–ª—å—à–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ edit_text (text, reply_markup, parse_mode –∏ —Ç.–ø.)
) -> None:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¢–ï–ö–°–¢ —Å–æ–æ–±—â–µ–Ω–∏—è.

    –ï—Å–ª–∏ Telegram –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É
    ¬´Bad Request: message is not modified¬ª (—Ç.–µ. —Ç–µ–∫—Å—Ç –∏ —Ä–∞–∑–º–µ—Ç–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç),
    –º—ã —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç–æ –∏ –Ω–µ –∑–∞—Å–æ—Ä—è–µ–º –ª–æ–≥–∏.
    –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ TelegramBadRequest –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ.
    """
    try:
        await message.edit_text(**kwargs)  # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∏/–∏–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Å–æ–æ–±—â–µ–Ω–∏—è
    except TelegramBadRequest as e:        # –õ–æ–≤–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ aiogram, –µ—Å–ª–∏ Telegram –≤–µ—Ä–Ω—É–ª Bad Request
        if "message is not modified" in e.message:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –æ—Ç Telegram –∏–º–µ–Ω–Ω–æ –ø—Ä–æ "message is not modified"
            return                         # –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–µ —Å—á–∏—Ç–∞—è —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π
        raise                              # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –¥—Ä—É–≥–∞—è ‚Äî –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –µ—ë –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –µ—ë –Ω–µ –∑–∞–º–∞–ª—á–∏–≤–∞—Ç—å


async def safe_edit_reply_markup(
    message: Message,  # –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    **kwargs,          # –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–±—Ä–æ—Å–∏–º –≤ edit_reply_markup (reply_markup=...)
) -> None:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –ö–õ–ê–í–ò–ê–¢–£–†–£ —É —Å–æ–æ–±—â–µ–Ω–∏—è.

    –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ safe_edit_text: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–ª—É—á–∞–π,
    –∫–æ–≥–¥–∞ Telegram –≥–æ–≤–æ—Ä–∏—Ç "message is not modified".
    """
    try:
        await message.edit_reply_markup(**kwargs)  # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Å–æ–æ–±—â–µ–Ω–∏—è
    except TelegramBadRequest as e:                # –õ–æ–≤–∏–º –æ—à–∏–±–∫—É –æ—Ç aiogram
        if "message is not modified" in e.message:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—à "–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–π" —Å–ª—É—á–∞–π
            return                           # –ú–æ–ª—á–∞ –≤—ã—Ö–æ–¥–∏–º, –ª–æ–≥ –Ω–µ –∑–∞—Å–æ—Ä—è–µ–º
        raise                                # –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ


async def remove_previous_bot_keyboard(
    state: FSMContext,    # –ö–æ–Ω—Ç–µ–∫—Å—Ç FSM ‚Äî –æ—Ç—Å—é–¥–∞ –¥–æ—Å—Ç–∞—ë–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
    bot,                  # –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ (bot = message.bot –∏–ª–∏ callback.message.bot)
    chat_id: int,         # ID —á–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Å–æ–æ–±—â–µ–Ω–∏—è
) -> None:
    """
    –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ ID —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ FSM.

    –õ–æ–≥–∏–∫–∞:
    - –¥–æ—Å—Ç–∞—ë–º –∏–∑ FSM –∫–ª—é—á "last_bot_message_id";
    - –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –≤—ã–∑—ã–≤–∞–µ–º edit_message_reply_markup —Å reply_markup=None;
    - –ª—é–±—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (—Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ / –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ç.–ø.).
    """
    data = await state.get_data()                       # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM (—Å–ª–æ–≤–∞—Ä—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    last_id: int | None = data.get("last_bot_message_id")  # –ü—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞

    if not last_id:                                     # –ï—Å–ª–∏ ID –≤–æ–æ–±—â–µ –Ω–µ—Ç –∏–ª–∏ –æ–Ω None
        return                                          # –ù–µ—á–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º

    try:
        # –ü—ã—Ç–∞–µ–º—Å—è —É–±—Ä–∞—Ç—å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
        await bot.edit_message_reply_markup(
            chat_id=chat_id,                            # –ß–∞—Ç, –≥–¥–µ –ª–µ–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
            message_id=last_id,                         # ID —Å–æ–æ–±—â–µ–Ω–∏—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏–º —É–±—Ä–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            reply_markup=None,                          # None ‚Äî –∑–Ω–∞—á–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞—Ç—å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        )
    except Exception:
        # –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º,
        # —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –ª–æ–≥–∏ –∏ –Ω–µ —Ä–æ–Ω—è—Ç—å —Ö—ç–Ω–¥–ª–µ—Ä.
        pass


# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ ‚Äî –≤ –Ω–µ–≥–æ –±—É–¥–µ–º "–≤–µ—à–∞—Ç—å" –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
registration_router = Router(name="registration")  # name ‚Äî —É–¥–æ–±–Ω–æ–µ –∏–º—è –¥–ª—è –¥–µ–±–∞–≥–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è


@registration_router.message(CommandStart())  # –•—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç /start
async def cmd_start(message: Message, state: FSMContext) -> None:
    """
    –°—Ç–∞—Ä—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–®–∞–≥ 1 –∏–∑ 3).
    """

    # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ).
    await remove_previous_bot_keyboard(
        state=state,                         # –ü–µ—Ä–µ–¥–∞—ë–º FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∞—Ç—å last_bot_message_id
        bot=message.bot,                     # –û–±—ä–µ–∫—Ç –±–æ—Ç–∞ –±–µ—Ä—ë–º –∏–∑ message.bot
        chat_id=message.chat.id,             # ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ (–¥–∏–∞–ª–æ–≥–∞), –≥–¥–µ –≤—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
    )

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ FSM ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º "—á–∏—Å—Ç—É—é" —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.
    await state.clear()

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: —Ç–µ–ø–µ—Ä—å –∂–¥—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    await state.set_state(RegistrationStates.waiting_for_phone)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π.
    sent_message = await message.answer(
        text=REQUEST_PHONE_TEXT,                       # –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        reply_markup=build_request_phone_keyboard(),  # Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        parse_mode="Markdown"                         # –†–∞–∑—Ä–µ—à–∞–µ–º Markdown (*–∂–∏—Ä–Ω—ã–π*, _–∫—É—Ä—Å–∏–≤_ –∏ —Ç.–ø.)
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–±—Ä–∞—Ç—å —É –Ω–µ–≥–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
    await state.update_data(last_bot_message_id=sent_message.message_id)


@registration_router.message(RegistrationStates.waiting_for_phone)  # –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è "–∂–¥—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω"
async def process_phone(message: Message, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç).
    –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–®–∞–≥ 2 –∏–∑ 3).
    """

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é phone (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ None)
    phone: str | None = None

    if message.contact and message.contact.phone_number:  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–Ω—Ç–∞–∫—Ç (—á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É)
        phone = "+" + message.contact.phone_number        # –ë–µ—Ä—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ contact –∏ –¥–æ–±–∞–≤–ª—è–µ–º "+" –≤ –Ω–∞—á–∞–ª–æ
    else:                                                 # –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –Ω–µ—Ç
        phone = message.text.strip() if message.text else None  # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –Ω–æ–º–µ—Ä –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å (–ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç / –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞)
    if not phone:
        # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ).
        await remove_previous_bot_keyboard(
            state=state,                     # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
            bot=message.bot,                 # –û–±—ä–µ–∫—Ç –±–æ—Ç–∞
            chat_id=message.chat.id,         # ID —á–∞—Ç–∞
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏/–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä –µ—â—ë —Ä–∞–∑.
        sent_message = await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –µ—â—ë —Ä–∞–∑."
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ last_bot_message_id.
        await state.update_data(last_bot_message_id=sent_message.message_id)

        return  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ö—ç–Ω–¥–ª–µ—Ä, –æ—Å—Ç–∞–≤–∞—è—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_phone

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —É–¥–∞–ª–æ—Å—å —Å—á–∏—Ç–∞—Ç—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ FSM.
    await state.update_data(phone=phone)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤ FSM —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –∫–∞–∫ –ø—É—Å—Ç–æ–π (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä –±—É–¥–µ–º –≤–µ—Å—Ç–∏ –≤ —ç—Ç–æ–º —Å–ø–∏—Å–∫–µ).
    await state.update_data(selected_banks=[])

    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤".
    await state.set_state(RegistrationStates.waiting_for_banks)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω.
    text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

    # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–∂–µ —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
    await remove_previous_bot_keyboard(
        state=state,                     # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
        bot=message.bot,                 # –û–±—ä–µ–∫—Ç –±–æ—Ç–∞
        chat_id=message.chat.id,         # ID —á–∞—Ç–∞
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤.
    sent_message = await message.answer(
        text=text,
        reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ü–µ—Ä–µ–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫: –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
        parse_mode="Markdown"
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞.
    await state.update_data(last_bot_message_id=sent_message.message_id)


@registration_router.callback_query(             # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å—ã
    RegistrationStates.waiting_for_banks,        # –•—ç–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_banks
    F.data.startswith("bank:")                   # –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "bank:"
)
async def process_bank_choice(
    callback: CallbackQuery,                     # –û–±—ä–µ–∫—Ç callback-–∑–∞–ø—Ä–æ—Å–∞ –æ—Ç Telegram (–Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É)
    state: FSMContext                            # –ö–æ–Ω—Ç–µ–∫—Å—Ç FSM –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (—à–∞–≥ 2).

    –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
    - "bank:<code>"   ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ–º/—É–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ selected_banks);
    - "bank:no_such"  ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª;
    - "bank:next"     ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–î–∞–ª–µ–µ ‚û°¬ª –∏ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤,
                        –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª.
    """

    data = callback.data                         # –°—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É callback_data, –Ω–∞–ø—Ä–∏–º–µ—Ä: "bank:sber", "bank:no_such", "bank:next"

    _, action = data.split(":", maxsplit=1)      # –û—Ç–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "bank" –∏ –ø–æ–ª—É—á–∞–µ–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è (sber / no_such / next)

    fsm_data = await state.get_data()            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    phone: str = fsm_data.get(                   # –î–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ
        "phone",                                 # –ö–ª—é—á, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–æ–º–µ—Ä
        "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"                             # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ—Ç –Ω–æ–º–µ—Ä–∞)
    )
    selected_banks: list[str] = fsm_data.get(    # –î–æ—Å—Ç–∞—ë–º —Å–ø–∏—Å–æ–∫ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
        "selected_banks",                        # –ö–ª—é—á, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
        []                                       # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    )

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 1: –ö–ù–û–ü–ö–ê ¬´–ù–ï–¢ –ù–£–ñ–ù–û–ì–û –ë–ê–ù–ö–ê üòü¬ª ----------

    if action == "no_such":                      # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü"
        no_banks_keyboard = build_no_bank_keyboard()  # –°—Ç—Ä–æ–∏–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –±–∞–Ω–∫–∞"

        await callback.answer()                  # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã Telegram —É–±—Ä–∞–ª "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏–π "–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
        await safe_edit_text(
            callback.message,                    # –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            text=NO_BANK_TEXT,                   # –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            reply_markup=no_banks_keyboard       # –ù–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        )

        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ no_banks
        await state.set_state(RegistrationStates.no_banks)

        # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id (–º—ã –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ–º —Å —ç—Ç–∏–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
        await state.update_data(last_bot_message_id=callback.message.message_id)

        return                                   # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ —Å—Ü–µ–Ω–∞—Ä–∏–π "no_such" –æ–±—Ä–∞–±–æ—Ç–∞–Ω

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 2: –ö–ù–û–ü–ö–ê ¬´–î–ê–õ–ï–ï ‚û°¬ª ----------

    if action == "next":                         # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ ‚û°"
        if not selected_banks:                   # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç
            await callback.answer(               # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞ üòü¬ª.",
                show_alert=True                  # show_alert=True ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç –ø–æ–≤–µ—Ä—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            )
            return                               # –ù–µ –¥–∞—ë–º —É–π—Ç–∏ –¥–∞–ª—å—à–µ, –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —á–∏—Ç–∞–µ–º—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –±–∞–Ω–∫–æ–≤ –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ç–µ–∫—Å—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º message_title –∏–∑ —Å–ª–æ–≤–∞—Ä—è BANKS).
        readable_banks = [
            BANKS[code]["message_title"]         # –ü–æ–ª—É—á–∞–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –ø–æ –µ–≥–æ –∫–æ–¥—É
            for code in selected_banks           # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –±–∞–Ω–∫–æ–≤
        ]
        banks_list_str = ", ".join(              # –°–∫–ª–µ–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
            readable_banks
        )

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞" —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤.
        main_bank_text = MAIN_BANK_CHOICE_TEXT_TEMPLATE.format(
            phone=phone,                         # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            banks_list=banks_list_str            # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
        )

        # –°—Ç—Ä–æ–∏–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞.
        main_bank_keyboard = build_main_bank_choice_keyboard(
            available_banks=selected_banks,      # –í –∫–∞—á–µ—Å—Ç–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∏
            main_bank=None                       # –ü–æ–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ FSM: –µ—â—ë —Ä–∞–∑ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤ –∏ —è–≤–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫.
        await state.update_data(
            selected_banks=selected_banks,
            main_bank=None
        )
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
        await state.set_state(RegistrationStates.waiting_for_main_bank)

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ.
        await callback.answer()

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
        await safe_edit_text(
            callback.message,                    # –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
            text=main_bank_text,                 # –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç
            reply_markup=main_bank_keyboard      # –ù–æ–≤–∞—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id: –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
        await state.update_data(last_bot_message_id=callback.message.message_id)

        return                                   # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ö—ç–Ω–¥–ª–µ—Ä

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 3: –í–´–ë–û–†/–°–ù–Ø–¢–ò–ï –û–¢–ú–ï–¢–ö–ò –° –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ë–ê–ù–ö–ê ----------

    bank_code = action                           # –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ action ‚Äî —ç—Ç–æ –∫–æ–¥ –±–∞–Ω–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "sber" –∏–ª–∏ "tbank"

    if bank_code in selected_banks:              # –ï—Å–ª–∏ —ç—Ç–æ—Ç –±–∞–Ω–∫ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        selected_banks.remove(bank_code)         # –£–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∂–∞–ª –≤—ã–±–æ—Ä)
    else:
        selected_banks.append(bank_code)         # –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —ç—Ç–æ—Ç –±–∞–Ω–∫)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –≤ FSM.
    await state.update_data(selected_banks=selected_banks)

    # –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤" —Å —É—á—ë—Ç–æ–º –Ω–æ–≤—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫—ñ–≤.
    new_keyboard = build_bank_choice_keyboard(
        selected_banks=selected_banks
    )

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ.
    await callback.answer()

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    await safe_edit_reply_markup(
        callback.message,                        # –°–æ–æ–±—â–µ–Ω–∏–µ, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –º–µ–Ω—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        reply_markup=new_keyboard                # –ù–æ–≤–∞—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –≥–∞–ª–æ—á–∫–∞–º–∏
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id –Ω–∞ ID —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    await state.update_data(last_bot_message_id=callback.message.message_id)


@registration_router.callback_query(             # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å—ã
    RegistrationStates.waiting_for_main_bank,   # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–æ–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞"
    F.data.startswith("main_bank:")             # –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "main_bank:"
)
async def process_main_bank_choice(callback: CallbackQuery, state: FSMContext) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ¬´–í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞¬ª.

    –í–æ–∑–º–æ–∂–Ω—ã–µ callback.data:
    - "main_bank:<code>" ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–∞–Ω–∫ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π;
    - "main_bank:back"   ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É ¬´–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤¬ª (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä);
    - "main_bank:next"   ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –±–∞–Ω–∫–æ–≤.
    """

    data: str = callback.data                   # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É callback_data, –Ω–∞–ø—Ä–∏–º–µ—Ä: "main_bank:sber"

    _, action = data.split(":", maxsplit=1)     # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ ":", –ø–æ–ª—É—á–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –¥–µ–π—Å—Ç–≤–∏–µ (–∫–æ–¥ –±–∞–Ω–∫–∞ / back / next)

    fsm_data: dict = await state.get_data()     # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM

    phone: str = fsm_data.get("phone", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")  # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

    selected_banks: list[str] = fsm_data.get("selected_banks", [])  # –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ —Å–æ —à–∞–≥–∞ 2

    main_bank: str | None = fsm_data.get("main_bank")  # –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ (–º–æ–∂–µ—Ç –±—ã—Ç—å None)

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 1: –ö–ù–û–ü–ö–ê ¬´–ù–ê–ó–ê–î¬ª (–í–û–ó–í–†–ê–¢ –ö –ú–£–õ–¨–¢–ò–í–´–ë–û–†–£) ----------

    if action == "back":
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤" (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä).
        await state.set_state(RegistrationStates.waiting_for_banks)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤" —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

        # –°—Ç—Ä–æ–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ —Å —É—á—ë—Ç–æ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤.
        keyboard = build_bank_choice_keyboard(selected_banks=selected_banks)

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ.
        await callback.answer()

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–∞ 2.
        await safe_edit_text(
            callback.message,             # –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            text=text,                    # –¢–µ–∫—Å—Ç "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤"
            reply_markup=keyboard         # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id –Ω–∞ ID —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
        await state.update_data(last_bot_message_id=callback.message.message_id)

        return  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 2: –ö–ù–û–ü–ö–ê ¬´–î–ê–õ–ï–ï¬ª (–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–°–ù–û–í–ù–û–ì–û –ë–ê–ù–ö–ê) ----------

    if action == "next":
        # –ó–¥–µ—Å—å –ø–æ-—Ö–æ—Ä–æ—à–µ–º—É –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –≤ –ë–î.

        final_text: str = BANK_CHOICE_DONE_TEXT_TEMPLATE  # –¢–µ–∫—Å—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" —É –∫–Ω–æ–ø–∫–∏.
        await callback.answer()

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å –ª–∏—à–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏.
        await callback.message.delete()

        # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–±—É–µ–º —É–±—Ä–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
        await remove_previous_bot_keyboard(
            state=state,                     # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
            bot=callback.message.bot,        # –û–±—ä–µ–∫—Ç –±–æ—Ç–∞
            chat_id=callback.message.chat.id # ID —á–∞—Ç–∞
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —É–±–∏—Ä–∞–µ–º reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
        sent_message = await callback.message.answer(
            text=final_text,
            reply_markup=ReplyKeyboardRemove()
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
        await state.update_data(last_bot_message_id=sent_message.message_id)

        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —á–∞—Å—Ç–∏ –±–∞–Ω–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
        await state.clear()

        return  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ö—ç–Ω–¥–ª–µ—Ä–∞

    # ---------- –°–¶–ï–ù–ê–†–ò–ô 3: –í–´–ë–û–† –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –û–°–ù–û–í–ù–û–ì–û –ë–ê–ù–ö–ê ----------

    bank_code: str = action                  # –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ action ‚Äî –∫–æ–¥ –±–∞–Ω–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sber")

    main_bank = bank_code                    # –°—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ—Ç –±–∞–Ω–∫ –≤—ã–±—Ä–∞–Ω –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π

    # –û–±–Ω–æ–≤–ª—è–µ–º –≤ FSM –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Å–Ω–æ–≤–Ω–æ–º –±–∞–Ω–∫–µ.
    await state.update_data(main_bank=main_bank)

    # –°—Ç—Ä–æ–∏–º –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞,
    # —á—Ç–æ–±—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –±–∞–Ω–∫–µ –ø–æ—è–≤–∏–ª–∞—Å—å –≥–∞–ª–æ—á–∫–∞.
    new_keyboard = build_main_bank_choice_keyboard(
        available_banks=selected_banks,
        main_bank=main_bank
    )

    # –ó–∞–∫—Ä—ã–≤–∞–µ–º "—á–∞—Å–∏–∫–∏" —É –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏.
    await callback.answer()

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º).
    await safe_edit_reply_markup(
        callback.message,                   # –°–æ–æ–±—â–µ–Ω–∏–µ —à–∞–≥–∞ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞
        reply_markup=new_keyboard           # –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –≥–∞–ª–æ—á–∫–æ–π
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id –Ω–∞ ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    await state.update_data(last_bot_message_id=callback.message.message_id)


@registration_router.callback_query(             # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å—ã
    RegistrationStates.no_banks,                 # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ no_banks
    F.data.startswith("no_bank:")                # –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ callback_data –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "no_bank:"
)
async def no_bank(
    callback: CallbackQuery,                     # –û–±—ä–µ–∫—Ç callback-–∑–∞–ø—Ä–æ—Å–∞
    state: FSMContext                            # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—à—ë–ª —Å–≤–æ–µ–≥–æ –±–∞–Ω–∫–∞.
    –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
    - "no_bank:back"  ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤;
    - "no_bank:start" ‚Äî –Ω–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.
    """

    data = callback.data                         # –°—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É callback_data, –Ω–∞–ø—Ä–∏–º–µ—Ä "no_bank:back"
    _, action = data.split(":", maxsplit=1)      # –ü–æ–ª—É—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ—Å–ª–µ "no_bank:"

    if action == "back":                         # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä—É –±–∞–Ω–∫–æ–≤
        await state.set_state(RegistrationStates.waiting_for_banks)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —à–∞–≥ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–æ–≤

        fsm_data = await state.get_data()        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ FSM
        phone: str = fsm_data.get(               # –î–æ—Å—Ç–∞—ë–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            "phone",
            "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"
        )

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–∞ "–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤" —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        text = BANK_CHOICE_TEXT_TEMPLATE.format(phone=phone)

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –≤–æ–∑–≤—Ä–∞—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –≤—ã–±–æ—Ä—É –±–∞–Ω–∫–æ–≤.
        await safe_edit_text(
            callback.message,                    # –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            text=text,                           # –¢–µ–∫—Å—Ç —à–∞–≥–∞ 2
            reply_markup=build_bank_choice_keyboard(selected_banks=[]),  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø—É—Å—Ç—ã–º –≤—ã–±–æ—Ä–æ–º
            parse_mode="Markdown"
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º last_bot_message_id.
        await state.update_data(last_bot_message_id=callback.message.message_id)

        return

    if action == "start":                        # –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
        await callback.message.delete()          # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π "–Ω–µ—Ç –±–∞–Ω–∫–∞"
        await state.clear()                      # –û—á–∏—â–∞–µ–º FSM ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –Ω—É–ª—è

        # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
        await remove_previous_bot_keyboard(
            state=state,
            bot=callback.message.bot,
            chat_id=callback.message.chat.id
        )

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞".
        await state.set_state(RegistrationStates.waiting_for_phone)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π.
        sent_message = await callback.message.answer(
            text=REQUEST_PHONE_TEXT,
            reply_markup=build_request_phone_keyboard(),
            parse_mode="Markdown"
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
        await state.update_data(last_bot_message_id=sent_message.message_id)

        return


@registration_router.message(                    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä –Ω–∞ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    RegistrationStates.no_banks                  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ no_banks
)
async def process_name(
    message: Message,                            # –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state: FSMContext                            # FSM-–∫–æ–Ω—Ç–µ–∫—Å—Ç
) -> None:
    """
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–∫—Å—Ç –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ "–Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –±–∞–Ω–∫–∞".
    –ó–¥–µ—Å—å –º–æ–∂–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞, –∫–æ—Ç–æ—Ä–æ–µ –æ–Ω –≤–≤—ë–ª, –∏ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å.
    """

    # –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
    await remove_previous_bot_keyboard(
        state=state,
        bot=message.bot,
        chat_id=message.chat.id,
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (–µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞).
    sent_message = await message.answer(
        text=NO_BANK_THANKS_TEXT,
        reply_markup=build_no_bank_keyboard()
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ last_bot_message_id.
    await state.update_data(last_bot_message_id=sent_message.message_id)
