# services/bot/texts/settings/cards.py

"""
–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —ç–∫—Ä–∞–Ω–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç¬ª.

–ó–∞–¥–∞—á–∞:
- –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
- —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤ ¬´–õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ¬ª –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º show_details;
- –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã –≤—ã–≤–µ—Å—Ç–∏:
  - —Å—Ç—Ä–æ–∫—É —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã (–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç, —ç–º–æ–¥–∑–∏ üí≥),
  - –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –±–∞–Ω–∫ –∫–∞—Ä—Ç—ã,
  - –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É,
  - –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏.
"""

from __future__ import annotations                                   # –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ (—É–¥–æ–±–Ω–æ –¥–ª—è type hints)

from typing import List                                              # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º List –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π —Ç–∏–ø–æ–≤

from ...database import get_user                                     # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ñ–∞–π–ª–æ–≤–æ–π "–ë–î"
from ..personal_cabinet import (                                     # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    CARD_MARK,                                                       # –≠–º–æ–¥–∑–∏ üí≥ –¥–ª—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    _wrap_with_indent,                                               # –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ç—Å—Ç—É–ø–æ–≤
    _format_bank_title,                                              # –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –±–∞–Ω–∫–∞
)


def build_cards_settings_text(
    user_id: int,                                                    # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–º—è JSON-—Ñ–∞–π–ª–∞ –≤ –ë–î)
) -> str:
    """
    –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —ç–∫—Ä–∞–Ω–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç¬ª –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
    - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã (—Ç–µ–ª–µ—Ñ–æ–Ω—ã –∑–¥–µ—Å—å –Ω–µ –≤—ã–≤–æ–¥–∏–º);
    - –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é (–∫–∞–∫ –≤ –õ–ö –ø—Ä–∏ show_details=True);
    - –∏—Å–ø–æ–ª—å–∑—É–µ–º Markdown (–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã).
    """

    user = get_user(user_id)                                         # –ó–∞–≥—Ä—É–∂–∞–µ–º (–∏–ª–∏ —Å–æ–∑–¥–∞—ë–º) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ user_id

    lines: List[str] = []                                            # –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –±—É–¥—É—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

    # --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫—Ä–∞–Ω–∞ --- #

    #lines.append("*–í–∞—à–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:*")                      # –û–±—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –±–ª–æ–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ (–∂–∏—Ä–Ω—ã–º)
    #lines.append("")                                                 # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞

    # --- –ó–∞–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --- #
    # –ü–æ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ user.cards:
    #   user.cards: Dict[str, CardData]
    # –≥–¥–µ CardData —Å–æ–¥–µ—Ä–∂–∏—Ç:
    #   - number (–∫–∞–∫ –∫–ª—é—á —Å–ª–æ–≤–∞—Ä—è)
    #   - bank (–∫–æ–¥ –±–∞–Ω–∫–∞, —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ None)
    #   - payment_system (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ None)

    user_cards = getattr(user, "cards", {})                          # –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –±–µ—Ä—ë–º —Å–ª–æ–≤–∞—Ä—å –∫–∞—Ä—Ç (–∏–ª–∏ {} –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π)
    has_cards: bool = bool(user_cards)                               # –§–ª–∞–≥ ‚Äî –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –∫–∞—Ä—Ç—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    if not has_cards:                                                # –ï—Å–ª–∏ –∫–∞—Ä—Ç –Ω–µ—Ç
        # –ü–∏—à–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤-–∫–∞—Ä—Ç –µ—â—ë –Ω–µ—Ç
        lines.append("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç.")  # –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ

        # –ü—Ä–æ–≥–æ–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å—á–∏–∫ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        wrapped_lines = [_wrap_with_indent(line) for line in lines]  # –ü–µ—Ä–µ–Ω–æ—Å–∏–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á—ë—Ç–æ–º –æ—Ç—Å—Ç—É–ø–æ–≤
        return "\n".join(wrapped_lines)                              # –°–∫–ª–µ–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ '\n' –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç

    # --- –§–æ—Ä–º–∏—Ä—É–µ–º –±–ª–æ–∫ –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–µ --- #

    for card_number, card_data in user_cards.items():                # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –ø–∞—Ä–∞–º (–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã, –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã)
        card_number_str = str(card_number)                           # –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

        # –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞—Ä—Ç –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é.
        # –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∏–º –µ–≥–æ –≤ –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω–æ–º —à—Ä–∏—Ñ—Ç–µ (Markdown-–∫–æ–¥ `–Ω–æ–º–µ—Ä`).
        number_display = f"`{card_number_str}`"                      # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –≤ –æ–±—Ä–∞—Ç–Ω—ã–µ –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã

        # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–∞—Ä—Ç—ã:
        # –ü—Ä–∏–º–µ—Ä: "*üí≥ –ö–∞—Ä—Ç–∞* `5555444433331111`"
        card_line = f"*{CARD_MARK} –ö–∞—Ä—Ç–∞* {number_display}"          # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —ç–º–æ–¥–∑–∏, –º–µ—Ç–∫–æ–π "–ö–∞—Ä—Ç–∞" –∏ –Ω–æ–º–µ—Ä–æ–º

        lines.append(card_line)                                      # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∫–∞—Ä—Ç—ã –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫

        # --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–∫–µ –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω) --- #

        card_bank_code = getattr(card_data, "bank", None)            # –ö–æ–¥ –±–∞–Ω–∫–∞, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫ –∫–∞—Ä—Ç–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å None)
        if card_bank_code:                                           # –ï—Å–ª–∏ –±–∞–Ω–∫ —É–∫–∞–∑–∞–Ω
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤—â–∏–∫ –±–∞–Ω–∫–æ–≤.
            # –ó–¥–µ—Å—å –Ω–µ –Ω—É–∂–µ–Ω —Å—Ç–∞—Ç—É—Å "(–æ—Å–Ω–æ–≤–Ω–æ–π)", –ø–æ—ç—Ç–æ–º—É is_main=False.
            card_bank_line = _format_bank_title(                     # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –±–∞–Ω–∫–∞
                bank_code=card_bank_code,                            # –ü–µ—Ä–µ–¥–∞—ë–º –∫–æ–¥ –±–∞–Ω–∫–∞
                is_main=False,                                       # –î–ª—è –∫–∞—Ä—Ç—ã –ø—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω—ã–π –±–∞–Ω–∫, –Ω–µ "–æ—Å–Ω–æ–≤–Ω–æ–π"
            )
            lines.append(card_bank_line)                             # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –±–∞–Ω–∫–æ–º –∫–∞—Ä—Ç—ã

        # --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞) --- #

        card_payment_system = getattr(card_data, "payment_system", None)  # –ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–∞—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ None)
        if card_payment_system:                                      # –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–∫–∞–∑–∞–Ω–∞
            # –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏: "    MIR" –∏–ª–∏ "    Visa"
            ps_line = f"    {card_payment_system}"                   # 4 –ø—Ä–æ–±–µ–ª–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
            lines.append(ps_line)                                    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

        # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏
        lines.append("")                                             # –û—Ç–¥–µ–ª—è–µ–º –±–ª–æ–∫–∏ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ä—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ

    # --- –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ —Å —É—á—ë—Ç–æ–º –æ—Ç—Å—Ç—É–ø–æ–≤ --- #

    wrapped_lines = [                                                # –î–ª—è –∫–∞–∂–¥–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–æ–∫–∏
        _wrap_with_indent(line)                                      # –¥–µ–ª–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–µ—Ñ–∏–∫—Å–∞ –æ—Ç—Å—Ç—É–ø–∞
        for line in lines
    ]

    # –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ '\n' –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    return "\n".join(wrapped_lines)                                  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞—Ä—Ç
