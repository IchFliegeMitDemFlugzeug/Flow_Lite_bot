# services/bot/texts/personal_cabinet.py

"""
–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —ç–∫—Ä–∞–Ω–∞ ¬´–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª.

–ó–∞–¥–∞—á–∞:
- —Å–æ–±—Ä–∞—Ç—å –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –ë–î –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö –∏ –±–∞–Ω–∫–∞—Ö;
- –æ—Ñ–æ—Ä–º–∏—Ç—å –µ—ë –≤ Markdown (–∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ add_headline);
- —É—á–∏—Ç—ã–≤–∞—Ç—å —Ñ–ª–∞–≥ show_details (—Å–∫—Ä—ã–≤–∞—Ç—å/–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã);
- –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ç—Å—Ç—É–ø–æ–≤.
"""

from __future__ import annotations                               # –†–∞–∑—Ä–µ—à–∞–µ–º "–æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ" –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ (—É–¥–æ–±–Ω–æ –¥–ª—è type hints)

import textwrap                                                  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å textwrap –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫
from typing import List                                          # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º List –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π —Ç–∏–ø–æ–≤

from ..database import get_user                                  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ "–±–∞–∑—ã"
from ..tools.banks_wordbook import BANKS                         # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –±–∞–Ω–∫–æ–≤ (–∫–æ–¥ -> –¥–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∞)


# –≠–º–æ–¥–∑–∏ –ø–µ—Ä–µ–¥ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∫–∞—Ä—Ç—ã
PHONE_MARK: str = "üì±"                                          # –≠—Ç–æ—Ç —Å–∏–º–≤–æ–ª –±—É–¥–µ—Ç —Å—Ç–æ—è—Ç—å –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞
CARD_MARK: str = "üí≥"
WHITE_SQUARE: str = "üì±"

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥ —Ä—É—á–Ω—ã–º –ø–µ—Ä–µ–Ω–æ—Å–æ–º
MAX_LINE_WIDTH: int = 30                                         # –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –¥–ª–∏–Ω—ã —Å—Ç—Ä–æ–∫–∏ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å


def _wrap_with_indent(line: str) -> str:
    """
    –ü–µ—Ä–µ–Ω–æ—Å–∏–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, —Å–æ—Ö—Ä–∞–Ω—è—è –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã (–ø—Ä–æ–±–µ–ª—ã/—Ç–∞–±—ã)
    –∏ –¥–æ–±–∞–≤–ª—è—è +2 –ø—Ä–æ–±–µ–ª–∞ –∫–æ –≤—Å–µ–º –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω–Ω—ã–º —Å—Ç—Ä–æ–∫–∞–º.

    –ü—Ä–∞–≤–∏–ª–∞:
    - –ø—Ä–µ—Ñ–∏–∫—Å–æ–º —Å—á–∏—Ç–∞–µ–º –≤—Å–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã ' ' –∏–ª–∏ '\t';
    - –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª) –∏–¥—ë—Ç —Å —ç—Ç–∏–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –∫–∞–∫ –µ—Å—Ç—å;
    - –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞) –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å + 2 –ø—Ä–æ–±–µ–ª–∞;
      –ø—Ä–∏ —ç—Ç–æ–º +2 –±–µ—Ä—É—Ç—Å—è –∏–º–µ–Ω–Ω–æ –∫ –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–û–ú–£ –ø—Ä–µ—Ñ–∏–∫—Å—É, –∞ –Ω–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.

    –ü—Ä–∏–º–µ—Ä:
        —Å—Ç—Ä–æ–∫–∞: "    –°–±–µ—Ä–±–∞–Ω–∫ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ ..."
        –ø—Ä–µ—Ñ–∏–∫—Å: "    "  (4 –ø—Ä–æ–±–µ–ª–∞)
        –ø–µ—Ä–µ–Ω–æ—Å: –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —Å "    ",
                 –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ ‚Äî —Å "      " (6 –ø—Ä–æ–±–µ–ª–æ–≤).
    """
    prefix_chars: List[str] = []                                # –°–ø–∏—Å–æ–∫ –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–µ—Ñ–∏–∫—Å–∞
    for ch in line:                                             # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Å–∏–º–≤–æ–ª–∞–º —Å—Ç—Ä–æ–∫–∏ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
        if ch in (" ", "\t"):                                   # –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª ‚Äî –ø—Ä–æ–±–µ–ª –∏–ª–∏ —Ç–∞–±—É–ª—è—Ü–∏—è
            prefix_chars.append(ch)                             # –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫ –ø—Ä–µ—Ñ–∏–∫—Å—É
        else:
            break                                               # –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞—Ç–∫–Ω—É–ª–∏—Å—å –Ω–∞ "–æ–±—ã—á–Ω—ã–π" —Å–∏–º–≤–æ–ª ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª

    prefix: str = "".join(prefix_chars)                         # –°–∫–ª–µ–∏–≤–∞–µ–º —Å–∏–º–≤–æ–ª—ã –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ —Å—Ç—Ä–æ–∫—É
    content: str = line[len(prefix):]                           # –û—Ç–¥–µ–ª—è–µ–º "–ø–æ–ª–µ–∑–Ω—É—é" —á–∞—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞

    if len(content) <= MAX_LINE_WIDTH:                          # –ï—Å–ª–∏ –ø–æ–ª–µ–∑–Ω–∞—è —á–∞—Å—Ç—å –∏ —Ç–∞–∫ –∫–æ—Ä–æ—Ç–∫–∞—è
        return line                                             # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

    # –°—Ç—Ä–æ–∫–∞ –¥–ª–∏–Ω–Ω–∞—è ‚Äî –¥–µ–ª–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å.
    # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–¥—ë—Ç —Å –∏—Å—Ö–æ–¥–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º,
    # –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ ‚Äî —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º + 2 –ø—Ä–æ–±–µ–ª–∞.
    wrapper = textwrap.TextWrapper(
        width=MAX_LINE_WIDTH,                                   # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏ (–≤–∫–ª—é—á–∞—è –ø—Ä–µ—Ñ–∏–∫—Å)
        initial_indent=prefix,                                  # –û—Ç—Å—Ç—É–ø –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
        subsequent_indent=prefix + "  ",                        # –û—Ç—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö (–ø—Ä–µ—Ñ–∏–∫—Å + 2 –ø—Ä–æ–±–µ–ª–∞)
        break_long_words=False,                                 # –ù–µ —Ä–∞–∑—Ä—ã–≤–∞–µ–º —Å–ª–æ–≤–∞ –ø–æ—Å—Ä–µ–¥–∏
        break_on_hyphens=False,                                 # –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø–æ –¥–µ—Ñ–∏—Å–∞–º
    )

    wrapped: str = wrapper.fill(content)                        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ —Å—Ç—Ä–æ–∫–∏

    return wrapped                                              # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏)


def _mask_phone_for_markdown(phone: str) -> str:
    """
    –í–µ—Ä–Ω—É—Ç—å –º–∞—Å–∫—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ "—Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫—Ä—ã—Ç—ã".

    –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å Markdown (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å *** –º–æ–∂–µ—Ç –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –∫–∞–∫ —Ä–∞–∑–º–µ—Ç–∫–∞),
    –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É—é –º–∞—Å–∫—É "–•–•–• 12-34" –±–µ–∑ –∑–≤—ë–∑–¥–æ—á–µ–∫.

    –ü—Ä–∏–º–µ—Ä:
        phone = "+79991234455" -> "–•–•–• 4455"
    """
    tail = phone[-4:] if len(phone) >= 4 else phone             # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞ (–∏–ª–∏ –≤–µ—Å—å –Ω–æ–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –∫–æ—Ä–æ—á–µ)
    masked_part = f"–•–•–• {tail}"                                 # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –º–∞—Å–∫–∏: "–•–•–• 4455"
    return masked_part                                          # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å–∫—É –±–µ–∑ Markdown-—Å–∏–º–≤–æ–ª–æ–≤


def _mask_card_for_markdown(card_number: str) -> str:
    """
    –í–µ—Ä–Ω—É—Ç—å –º–∞—Å–∫—É –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ "—Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫—Ä—ã—Ç—ã".

    –õ–æ–≥–∏–∫–∞ —Ç–∞–∫–∞—è –∂–µ, –∫–∞–∫ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:
    - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞;
    - –ø—Ä–µ—Ñ–∏–∫—Å "–•–•–• " –±–µ–∑ Markdown-—Å–∏–º–≤–æ–ª–æ–≤.

    –ü—Ä–∏–º–µ—Ä:
        card_number = "5555444433331111" -> "–•–•–• 1111"
    """
    tail = card_number[-4:] if len(card_number) >= 4 else card_number  # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    masked_part = f"–•–•–• {tail}"                                        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –º–∞—Å–∫–∏: "–•–•–• 1111"
    return masked_part                                                 # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è


def _format_bank_title(bank_code: str, is_main: bool) -> str:
    """
    –í–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –±–∞–Ω–∫–∞.

    –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
    - –∫–∞–∂–¥—ã–π –±–∞–Ω–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —á–µ—Ç—ã—Ä—ë—Ö –ø—Ä–æ–±–µ–ª–æ–≤;
    - –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –∫—É—Ä—Å–∏–≤–æ–º (*...*) –∏ –ø–æ–º–µ—Ç–∫–æ–π "(–æ—Å–Ω–æ–≤–Ω–æ–π)";
    - –æ–±—ã—á–Ω—ã–π –±–∞–Ω–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç.

    –ü—Ä–∏–º–µ—Ä—ã:
        –æ–±—ã—á–Ω—ã–π: "    –°–±–µ—Ä–±–∞–Ω–∫"
        –æ—Å–Ω–æ–≤–Ω–æ–π: "    *–¢-–ë–∞–Ω–∫ (–æ—Å–Ω–æ–≤–Ω–æ–π)*"
    """
    bank = BANKS.get(bank_code)                                 # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –ø–æ –µ–≥–æ –∫–æ–¥—É
    if bank is not None:                                        # –ï—Å–ª–∏ –±–∞–Ω–∫ –Ω–∞–π–¥–µ–Ω –≤ —Å–ª–æ–≤–∞—Ä–µ
        title = (                                               # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            bank.get("message_title")                           # –°–Ω–∞—á–∞–ª–∞ message_title
            or bank.get("button_title")                         # –ø–æ—Ç–æ–º button_title
            or bank_code                                        # –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥ –±–∞–Ω–∫–∞
        )
    else:
        title = bank_code                                       # –ï—Å–ª–∏ –±–∞–Ω–∫ –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥

    if is_main:                                                 # –ï—Å–ª–∏ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫
        return f"    *{title} (–æ—Å–Ω–æ–≤–Ω–æ–π)*"                      # 4 –ø—Ä–æ–±–µ–ª–∞ + –∫—É—Ä—Å–∏–≤ —Å –ø–æ–º–µ—Ç–∫–æ–π "(–æ—Å–Ω–æ–≤–Ω–æ–π)"
    else:
        return f"    {title}"                                   # 4 –ø—Ä–æ–±–µ–ª–∞ + –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)


def build_personal_cabinet_text(
    user_id: int,                                               # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
    show_details: bool,                                         # –§–ª–∞–≥: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Ü–µ–ª–∏–∫–æ–º
) -> str:
    """
    –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —ç–∫—Ä–∞–Ω–∞ ¬´–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π Markdown, —É–∂–µ —Ä–∞–∑–±–∏—Ç–∞—è –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —Å —É—á—ë—Ç–æ–º –æ—Ç—Å—Ç—É–ø–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤.
    """
    user = get_user(user_id)                                   # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ñ–∞–π–ª–æ–≤–æ–π "–±–∞–∑—ã"

    lines: List[str] = []                                      # –°–ø–∏—Å–æ–∫ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫ –±—É–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

    # --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫—Ä–∞–Ω–∞ --- #

    lines.append("*–í–∞—à–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:*")                 # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫, –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –∫—É—Ä—Å–∏–≤–æ–º (Markdown)
    lines.append("")                                           # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å

    # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –∫–∞–∫–∏–µ-–ª–∏–±–æ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (—Ç–µ–ª–µ—Ñ–æ–Ω—ã –∏–ª–∏ –∫–∞—Ä—Ç—ã) --- #

    has_phones = bool(user.phones)                            # True, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–ª–µ—Ñ–æ–Ω
    user_cards = getattr(user, "cards", {})                   # –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –±–µ—Ä—ë–º —Å–ª–æ–≤–∞—Ä—å –∫–∞—Ä—Ç (–Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π)
    has_cards = bool(user_cards)                              # True, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞

    if not has_phones and not has_cards:                      # –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –Ω–∏ –∫–∞—Ä—Ç
        lines.append("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤.")  # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å—á–∏–∫, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –æ—Ç—Å—Ç—É–ø—ã (—Ö–æ—Ç—è –∏—Ö —Ç—É—Ç –∏ –Ω–µ—Ç)
        wrapped_lines = [_wrap_with_indent(line) for line in lines]
        return "\n".join(wrapped_lines)                       # –°–∫–ª–µ–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ '\n' –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç

    # --- –ë–ª–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–∫–∞–∫ –±—ã–ª, —Ç–æ–ª—å–∫–æ –æ–±—ë—Ä–Ω—É—Ç –≤ –ø—Ä–æ–≤–µ—Ä–∫—É has_phones) --- #
    # user.phones ‚Äî —Å–ª–æ–≤–∞—Ä—å –≤–∏–¥–∞: { "–Ω–æ–º–µ—Ä": PhoneData }

    if has_phones:                                            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω—ã ‚Äî –≤—ã–≤–æ–¥–∏–º –∏—Ö
        for phone, phone_data in user.phones.items():         # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –ø–∞—Ä–∞–º (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–µ–º—É)

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–ª–∞–≥–∞ show_details
            if show_details:                                  # –ï—Å–ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
                phone_line = f"*{PHONE_MARK} –¢–µ–ª–µ—Ñ–æ–Ω {phone}:*"  # –ü—Ä–∏–º–µ—Ä: "*‚ñ´ –¢–µ–ª–µ—Ñ–æ–Ω +79991234455:*"
            else:                                             # –ï—Å–ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å
                masked = _mask_phone_for_markdown(phone)      # –ü–æ–ª—É—á–∞–µ–º –º–∞—Å–∫—É –≤–∏–¥–∞ "–•–•–• 4455"
                phone_line = f"*{PHONE_MARK} –¢–µ–ª–µ—Ñ–æ–Ω {masked}:*"  # –ü—Ä–∏–º–µ—Ä: "*‚ñ´ –¢–µ–ª–µ—Ñ–æ–Ω –•–•–• 4455:*"

            lines.append(phone_line)                          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫

            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            banks = list(phone_data.banks or [])              # –ë–µ—Ä—ë–º —Å–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –±–∞–Ω–∫–æ–≤ (–∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)
            main_bank = phone_data.main_bank                  # –ö–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–Ω–∫–∞ (–∏–ª–∏ None)

            # --- –ï—Å–ª–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –±–∞–Ω–∫–∏ --- #

            if not banks:                                     # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç
                lines.append("    (–±–∞–Ω–∫–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã)")        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å 4 –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º
                lines.append("")                              # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏
                continue                                      # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞

            # --- –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –±–∞–Ω–∫—É --- #

            for bank_code in banks:                           # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –∫–æ–¥–∞–º –±–∞–Ω–∫–æ–≤
                is_main = (main_bank is not None) and (bank_code == main_bank)
                # is_main = True, –µ—Å–ª–∏ —ç—Ç–æ—Ç –±–∞–Ω–∫ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

                bank_line = _format_bank_title(bank_code, is_main)  # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –±–∞–Ω–∫–∞ (—Å –Ω—É–∂–Ω—ã–º –æ—Ç—Å—Ç—É–ø–æ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
                lines.append(bank_line)                       # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –±–∞–Ω–∫–∞ –≤ —Å–ø–∏—Å–æ–∫

            lines.append("")                                  # –ü–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

    # --- –ë–ª–æ–∫ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç (–¥–æ–±–∞–≤–ª–µ–Ω) --- #
    # user.cards ‚Äî —Å–ª–æ–≤–∞—Ä—å –≤–∏–¥–∞: { "–Ω–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã": CardData }

    if has_cards:                                             # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∫–∞—Ä—Ç—ã ‚Äî –≤—ã–≤–æ–¥–∏–º –∏—Ö
        for card_number, card_data in user_cards.items():     # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –ø–∞—Ä–∞–º (–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã, –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ä—Ç–µ)
            card_number_str = str(card_number)                # –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)

            # –§–æ—Ä–º–∏—Ä—É–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ —Å—Ç—Ä–æ–∫–µ —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç show_details
            if show_details:                                  # –ï—Å–ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
                # –ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–Ω–æ-—à—Ä–∏—Ñ—Ç–æ–º (Markdown-–∫–æ–¥) –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                number_display = f"`{card_number_str}`"       # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –≤ –æ–±—Ä–∞—Ç–Ω—ã–µ –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã
                # –ü—Ä–∏–º–µ—Ä: "*‚ñ´ –ö–∞—Ä—Ç–∞* `5555444433331111`"
                card_line = f"*{CARD_MARK} –ö–∞—Ä—Ç–∞* {number_display}"
            else:                                             # –ï—Å–ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å
                masked = _mask_card_for_markdown(card_number_str)  # –ú–∞—Å–∫–∞ "–•–•–• 1111"
                # –ü—Ä–∏–º–µ—Ä: "*‚ñ´ –ö–∞—Ä—Ç–∞ –•–•–• 1111*"
                card_line = f"*{CARD_MARK} –ö–∞—Ä—Ç–∞ {masked}*"

            lines.append(card_line)                           # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–∞—Ä—Ç–æ–π –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫

            # --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–∫–µ –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω) --- #

            card_bank_code = getattr(card_data, "bank", None) # –ö–æ–¥ –±–∞–Ω–∫–∞ –¥–ª—è –∫–∞—Ä—Ç—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å None)
            if card_bank_code:                                # –ï—Å–ª–∏ –±–∞–Ω–∫ —É–∫–∞–∑–∞–Ω
                # –î–ª—è –±–∞–Ω–∫–∞ –∫–∞—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ –∏ –¥–ª—è –±–∞–Ω–∫–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–±–µ–∑ "(–æ—Å–Ω–æ–≤–Ω–æ–π)")
                card_bank_line = _format_bank_title(card_bank_code, is_main=False)
                lines.append(card_bank_line)                  # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –±–∞–Ω–∫–æ–º –∫–∞—Ä—Ç—ã

            # --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞) --- #

            card_ps = getattr(card_data, "payment_system", None)  # –ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∫–∞—Ä—Ç—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å None)
            if card_ps:                                        # –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–∫–∞–∑–∞–Ω–∞
                ps_line = f"    {card_ps}"  # –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ —Å 4 –ø—Ä–æ–±–µ–ª–∞–º–∏
                lines.append(ps_line)                          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

            lines.append("")                                   # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏

    # --- –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ç—Å—Ç—É–ø–æ–≤ --- #

    wrapped_lines = [                                          # –î–ª—è –∫–∞–∂–¥–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–æ–∫–∏
        _wrap_with_indent(line)                                # –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å —É—á—ë—Ç–æ–º –æ—Ç—Å—Ç—É–ø–æ–≤
        for line in lines
    ]

    # –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ '\n' –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    return "\n".join(wrapped_lines)                            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
