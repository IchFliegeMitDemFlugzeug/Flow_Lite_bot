# Импортируем стандартный модуль asyncio,
# он нужен для запуска асинхронного кода (aiogram работает асинхронно)
import asyncio

# Импортируем стандартный модуль os,
# с его помощью мы будем читать переменные окружения (BOT_TOKEN из .env через Docker)
import os

# Из пакета aiogram импортируем класс Bot,
# он представляет нашего Telegram-бота и умеет отправлять сообщения, получать обновления и т.д.
from aiogram import Bot, Dispatcher


# Объявляем константу с именем переменной окружения,
# чтобы не писать строку "BOT_TOKEN" вручную в нескольких местах и не ошибиться в имени
ENV_BOT_TOKEN_NAME: str = "BOT_TOKEN"


# Определяем асинхронную функцию main, это будет точка входа для запуска бота
async def main() -> None:
    """
    Основная асинхронная функция запуска бота.
    Здесь мы:
    1) читаем токен из переменных окружения,
    2) создаём объект бота и диспетчер,
    3) запускаем бесконечный опрос Telegram (polling).
    """

    # Читаем значение переменной окружения BOT_TOKEN,
    # если её нет, os.getenv вернёт None
    raw_token: str | None = os.getenv(ENV_BOT_TOKEN_NAME)

    # Проверяем, что токен действительно найден
    # Если токена нет (None или пустая строка), поднимаем исключение и завершаем программу
    if not raw_token:
        # Формируем понятный текст ошибки, чтобы по логам было сразу видно,
        # что именно не так настроено
        message: str = (
            f"Переменная окружения {ENV_BOT_TOKEN_NAME!r} не задана. "
            f"Убедись, что в файле .env указан BOT_TOKEN и он передаётся в контейнер."
        )
        # Выбрасываем исключение RuntimeError с этим сообщением
        raise RuntimeError(message)

    # Если токен успешно прочитан, создаём объект бота,
    # передавая ему токен, полученный из окружения
    bot: Bot = Bot(token=raw_token)

    # Создаём объект диспетчера,
    # через него будем регистрировать обработчики команд и сообщений (позже)
    dp: Dispatcher = Dispatcher()

    # Запускаем бесконечный опрос сервера Telegram.
    # Метод start_polling будет получать все входящие обновления (апдейты)
    # и передавать их зарегистрированным обработчикам.
    # Пока обработчиков нет — это нормально, бот просто "слушает" Telegram.
    await dp.start_polling(bot)


# Этот блок выполняется только если файл запускают напрямую как скрипт:
# python services/bot/main.py
if __name__ == "__main__":
    # Вызываем функцию asyncio.run, чтобы запустить нашу асинхронную функцию main()
    # Это стандартный способ запуска "async def main()" в обычном Python-скрипте
    asyncio.run(main())
